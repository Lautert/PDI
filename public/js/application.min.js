/*! Application - v0.0.0 - 2019-12-04 */
var PDI=function(t){function e(){this.original=new Image,this.image=new Image,this.processes=[],this.grayScaleType="media",this.grid=[],this.reset()}return e.prototype={setGrayScale:function(t){this.grayScaleType=t},reset:function(){this.statistics={average:0,median:0,variance:0,moda:0,totalPx:0},this.histogram={},this.histogram.gray=Array(256).fill(0),this.histogram.rgb={r:Array(256).fill(0),g:Array(256).fill(0),b:Array(256).fill(0)},this.grid=[]},loadImagem:function(t,e){var a=this;a.original.src=URL.createObjectURL(t),a.image.src=URL.createObjectURL(t),"function"==typeof e&&(a.original.onload=function(){e(a.original),a.resetImage(),a.convertToGrid()}),this.reset()},resetImage:function(t){t&&(this.processes=[]);var e=document.createElement("canvas");e.width=this.original.width,e.height=this.original.height;var a=e.getContext("2d");return a.drawImage(this.original,0,0),this.image=a.getImageData(0,0,this.original.width,this.original.height),[this.image]},getImageData:function(){var t=document.createElement("canvas");if(this.image instanceof Image){var e,a=this.image;return t.width=a.width,t.height=a.height,(e=t.getContext("2d")).drawImage(a,0,0),e.getImageData(0,0,a.width,a.height)}if(this.image instanceof ImageData)return t.width=this.image.width,t.height=this.image.height,(e=t.getContext("2d")).putImageData(this.image,0,0),e.getImageData(0,0,this.image.width,this.image.height)},getPixelData:function(t,e,a){var i=a.width,n=(a.height,e*i*4+4*t);return[a.data[n],a.data[n+1],a.data[n+2],a.data[n+3],n]},applyFilter:function(){var t=Array.from(arguments),e=t.shift();return void 0===t&&(t={}),this.processes.push({name:e,params:t}),this.processImage()},processImage:function(){this.resetImage();var t=[];for(var e in this.processes){var a=this.processes[e],i=a.name,n=a.params,r=this[i].apply(this,n)[0];t.push(r),this.image=r}return t},getStatistics:function(){return this.statistics},getHistogram:function(t){if("gray"==t)return this.filterGray(),this.histogram.gray;if("rgb"==t)for(var e=this.getImageData(),a=0;a<e.data.length;a+=4)histogram.r[e.data[a]]++,histogram.g[e.data[a+1]]++,histogram.b[e.data[a+2]]++},blankMatrix:function(t,e,a=255){var i=document.createElement("canvas");return i.width=t,i.height=e,i.getContext("2d").getImageData(0,0,t,e)},convertToGrid:function(){for(var t=this.getImageData(),e=this.image.width,a=(this.image.height,0),i=0,n=0;a<t.data.length;a+=4,i++)i==e&&(i=0,n++),void 0===this.grid[n]&&(this.grid[n]=[]),void 0===this.grid[n][i]&&(this.grid[n][i]=[]),this.grid[n][i]=[t.data[a],t.data[a+1],t.data[a+2],t.data[a+3],a]},showMatrix:function(t,e){if(e){var a=[];for(r=0;r<matrixData.length;r++){void 0==a[r]&&(a[r]=[]);for(var i=0;i<matrixData[0].length;i++){void 0==a[r][i]&&(a[r][i]=[]);var n=matrixData[r][i];a[r][i]="[ "+n.join(" ")+" ]",_this.showMatrix(a)}}}else for(var r=0;r<t.length;r++)console.log("[ "+t[r].join(" ")+" ]")},filterMatrixConvolution:function(t,e,a=null){for(var i=[0,0,0,0],n=0;n<t.length;n++)for(var r=0;r<t[0].length;r++){var s=t[n][r],o=e[n][r];s.map(function(t,e){i[e]+=t*o})}return"function"==typeof a&&(i=a(i)),i},getMatrixFromData:function(t,e,a,i,n){void 0===n&&(n=this.getImageData());for(var r=[],s=0;s<i;s++){void 0==r[s]&&(r[s]=[]);for(var o=0;o<a;o++){void 0==r[s][o]&&(r[s][o]=[]);var l=t+o,d=e+s;l<0||d<0||l>=n.width||d>=n.height?r[s][o]=[127,127,127,255]:r[s][o]=this.getPixelData(l,d,n).slice(0)}}return r},applyFilterMatrix:function(t,e=null){for(var a=t.length%2==0?[Math.floor(t.length/2),Math.ceil(t.length/2)]:[Math.floor(t.length/2)],i=Math.abs(0-Math.min.apply(null,a)),n=t[0].length%2==0?[Math.floor(t[0].length/2),Math.ceil(t[0].length/2)]:[Math.floor(t[0].length/2)],r=Math.abs(0-Math.min.apply(null,n)),s=this.getImageData(),o=this.getImageData(),l=o.width,d=(o.height,0);d<=o.data.length;d+=4){var h=Math.floor(d/4/l),g=Math.abs(d-h*l*4)/4,c=this.getMatrixFromData(g-r,h-i,t[0].length,t.length,s),m=this.filterMatrixConvolution(c,t,e);o.data[d]=m[0],o.data[d+1]=m[1],o.data[d+2]=m[2]}return[o]},getVfromType:function(t,e,a){return"media"==this.grayScaleType?(t+e+a)/3:"grayscale"==this.grayScaleType?.3*t+.59*e+.11*a:"desaturate"==this.grayScaleType?(Math.max(t,e,a)+Math.min(t,e,a))/2:"hsv"==this.grayScaleType?Math.max(t,e,a):(t+e+a)/3},filterGray:function(){var t=this,e=t.getImageData(),a=0,i=0;t.histogram.gray=Array(256).fill(0);for(var n=0;n<e.data.length;n+=4){var r=e.data[n],s=e.data[n+1],o=e.data[n+2],l=(e.data[n+3],t.getVfromType(r,s,o));e.data[n]=l,e.data[n+1]=l,e.data[n+2]=l,t.histogram.gray[l]++,a+=l,i++}return t.statistics.average=a/i,t.statistics.totalPx=i,function(){for(var e=t.getImageData(),a=0,i=0;i<e.data.length;i+=4){var n=e.data[i],r=e.data[i+1],s=e.data[i+2],o=(e.data[i+3],t.getVfromType(n,r,s));a+=Math.pow(o-t.statistics.average,2)}t.statistics.variance=a/t.statistics.totalPx,e.data.sort((t,e)=>e-t),t.statistics.median=e.data[e.data.length/2];var l={px:null,total:0};t.histogram.gray.map(function(t,e){t>=l.total&&(l.total=t,l.px=e)}),t.statistics.moda=l.px}(),[e]},brightnessContrast:function(t,e){for(var a=t,i=e,n=this.getImageData(),r=0;r<n.data.length;r+=4)for(let t=0;t<3;t++)n.data[r+t]=n.data[r+t]*i+a,n.data[r+t]>255&&(n.data[r+t]=255),n.data[r+t]<0&&(n.data[r+t]=0);return this.image=n,[n]},negative:function(){for(var t=this.getImageData(),e=0;e<t.data.length;e+=4)for(let a=0;a<3;a++)t.data[e+a]=255-t.data[e+a];return[t]},transform:function(t,e,a){t=Math.floor(t),e=Math.floor(e);var i=this,n=[];function r(){n.push(i.blankMatrix(t,e))}r();for(var s=i.getImageData().data,o=(i.image.width,i.image.height,i.image.width,i.image.height,0),l=0,d=0;d<=n[0].data.length;d+=4){(l=d/4-t*o)==t&&o++;var h=Math.floor(a[0]*l+a[3]*o+a[6]),g=Math.floor(a[1]*l+a[4]*o+a[7]),c=d;if(h>=0&&h<=i.image.width&&g>=0&&g<=i.image.height)var m=[{newPixel:Math.floor(4*(g*i.image.width+h))}.newPixel];else m=[0];for(var f=0;f<m.length;f++){void 0===n[f]&&r();var u=m[f];n[f].data[c]=s[u],n[f].data[c+1]=s[u+1],n[f].data[c+2]=s[u+2],n[f].data[c+3]=s[u+3]}}return n},transladar:function(t,e,a,i){var n=this.image.width+e+i,r=this.image.height+t+a,s=[1,0,0,0,1,0,0,0,1];e>0&&(s[6]=-e,s[0]),t>0&&(s[7]=-t,s[0]);var o=this.transform(n,r,s);return this.image=o[0],o},resize:function(t,e){(t>=4||t<=0)&&(alert("Intervalo aceito para X [0, 4] e != 0"),t=1),(e>=4||e<=0)&&(alert("Intervalo aceito para Y [0, 4] e != 0"),e=1);var a=this.image.width*t,i=this.image.height*e,n=[1,0,0,0,1,0,0,0,1];n[0]=1/t,n[4]=1/e;var r=this.transform(a,i,n);return this.image=r[0],r},rotate:function(t){var e=this.image.width,a=this.image.height,i=Math.cos(t*Math.PI/180),n=Math.sin(t*Math.PI/180),r=[i,-n,0,n,i,0,-n*e/2-i*a/2+a/2,-i*e/2+n*a/2+e/2,1];return this.transform(e,a,r)},mirror:function(t,e){var a=this.image.width,i=this.image.height,n=[1,0,0,0,1,0,0,0,1];t>0&&(n[0]=-t,n[6]=this.image.width),e>0&&(n[4]=-e,n[7]=this.image.height);var r=this.transform(a,i,n);return this.image=r[0],r},aliasing:function(){this.getImageData().data;var t=this.blankMatrix(this.image.width,this.image.height);t.data;return t},binary:function(t){for(var e=this.filterGray()[0],a=0;a<e.data.length;a+=4)for(let n=0;n<3;n++){var i=e.data[a+n]>t?255:0;e.data[a+n]=i}return[e]},domino:function(){var t=this,e={};function a(a,i,n){var r={},s={x:{min:a,max:a},y:{min:i,max:i}};return function a(i,n,o){if(void 0===e[i]||void 0===e[i][n]){void 0===e[i]&&(e[i]={}),e[i][n]=!0;var l=function(e,a,i){var n=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],r=[];for(var s in n){var o=n[s],l=e+o[0],d=a+o[1];0===t.getPixelData(e+o[0],a+o[1],i)[0]&&r.push({x:l,y:d})}return r}(i,n,o);for(var d in l){var h=l[d],g=h.x,c=h.y;void 0===r[g]&&(r[g]={}),void 0===r[g][c]&&(r[g][c]={},r[g][c]=0,g<s.x.min&&(s.x.min=g),g>s.x.max&&(s.x.max=g),c<s.y.min&&(s.y.min=c),c>s.y.max&&(s.y.max=c),a(h.x,h.y,o))}}}(a,i,n),Object.keys(r).length>0?{limits:s,grid:r}:null}function i(e,a){for(var i=e.limits.x.max-e.limits.x.min,n=e.limits.y.max-e.limits.y.min,r=t.blankMatrix(i,n),s=0;s<=i;s++)for(var o=e.limits.x.min+s,l=0;l<=n;l++){var d=e.limits.y.min+l,h=[255,255,255,255];void 0!==e.grid[o]&&void 0!==e.grid[o][d]&&(h=t.getPixelData(o,d,a));var g=l*i*4+4*s;r.data[g]=h[0],r.data[g+1]=h[1],r.data[g+2]=h[2],r.data[g+3]=255}return r}function n(t){for(var e=0,a=0;a<t.data.length;a+=4)0==t.data[a]&&e++;return e}function r(e){var a=e.dataImg,i=a.width,r=a.height,s=document.createElement("canvas");s.width=i,s.height=r;var o=s.getContext("2d");o.putImageData(a,0,0),t.image=o.getImageData(0,0,a.width,a.height);var l=t.binary(215);t.image=l[0];var d=4*(i*Math.floor(r/2)+Math.floor(i/2)),h=Math.floor(i/2),g=Math.floor(r/2),c=[];[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]].map(function(e,a){var n=h,s=g,o=0,l=!0;do{if(l=!1,n+=e[0],s+=e[1],n>=0&&n<i&&s>=0&&s<r)0===t.getPixelData(n,s,t.image)[0]&&(l=!0,o++)}while(l);c.push(o)});var m="undefined";m=function(t){return t[0]<t[1]&&t[4]<t[3]&&t[7]<t[0]&&t[5]<t[4]&&.7*t[1]<=t[3]&&t[3]<=1.3*t[1]&&.7*t[3]<=t[6]&&t[6]<=1.3*t[3]&&.7*t[1]<=t[6]&&t[6]<=1.3*t[1]&&.7*t[0]<=t[4]&&t[4]<=1.3*t[0]}(c)?"Triangulo":function(e){var a=n(t.image),i=Math.max(e[0],e[2],e[4],e[6]),r=Math.PI*i*i;return.9*r<=a&&a<=1.2*r}(c)?"Circulo":function(e){var a=n(t.image),i=Math.min(e[0],e[2],e[4],e[6]),r=Math.max(e[0],e[2],e[4],e[6]),s=Math.PI*i*r;return.8*s<=a&&a<=1.2*s}(c)?"Elipse":function(t){var e=t[0]+t[4],a=t[2]+t[6];return.9*e<=i&&i<=1.1*e&&.9*a<=r&&r<=1.1*a&&.9*t[1]<=t[0]&&t[0]<=1.1*t[1]&&.9*t[3]<=t[2]&&t[2]<=1.1*t[3]&&.9*t[5]<=t[4]&&t[4]<=1.1*t[5]&&.9*t[7]<=t[6]&&t[6]<=1.1*t[7]&&.9*i<=r&&r<=1.1*i}(c)?"Quadrado":function(t){var e=t[0]+t[4],a=t[2]+t[6];return.9*e<=i&&i<=1.1*e&&.9*a<=r&&r<=1.1*a&&.9*t[0]<=t[4]&&t[4]<=1.1*t[0]&&.9*t[4]<=t[0]&&t[0]<=1.1*t[4]&&.9*t[2]<=t[1]&&t[1]<=1.1*t[2]&&.9*t[6]<=t[5]&&t[5]<=1.1*t[6]&&(1.1*i<=r||r<=1.1*i)}(c)?"Retangulo":function(t){return t[1]<t[0]&&t[3]<t[2]&&t[5]<t[4]&&t[7]<t[6]&&.7*t[0]<=t[4]&&t[4]<=1.3*t[0]&&.7*t[2]<=t[6]&&t[6]<=1.3*t[2]&&.7*t[4]<=t[6]&&t[6]<=1.3*t[4]&&.7*t[6]<=t[0]&&t[0]<=1.3*t[6]}(c)?"Losango":"undefined";var f=t.getPixelData(h,g,a);return t.image.data[d]=255,t.image.data[d+1]=0,t.image.data[d+2]=0,t.image.data[d+3]=255,e.type=m,e.color={R:f[0],G:f[1],B:f[2]},e}this.resetImage();var s=t.getImageData(),o=t.applyFilter("binary",215);t.image=o[0];for(var l=[],d=t.getImageData(),h=d.width,g=(d.height,0);g<=d.data.length;g+=4){var c=Math.floor(g/4/h),m=Math.abs(g-c*h*4)/4;if(0===d.data[g]){var f=a(m,c,d);null!==f&&(f.dataImg=i(f,s),l.push(r(f)))}}return l=l.filter(t=>void 0!=t.type&&"undefined"!=t.type)}},e}(jQuery),Application=function(t,e){function a(){this.elements={inputFile:null,contentHead:null,contentBody:null,canvasOri:null,canvasChg:null,modals:{config:null}}}return window.Pdi=e,a.prototype={renderOrigin:function(t){var e=this.elements.canvasOri.get(0);e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0),this.elements.canvasOri.parents("div.content-image:eq(0)").find(".image-result").find(".img-size").text(t.width+"x"+t.height)},loadStatistics:function(){var a=e.getStatistics(),i=t(".statistics");i.removeClass("d-none"),i.find(".media span").text(a.average.toFixed(2)),i.find(".mediana span").text(a.median),i.find(".vari span").text(a.variance.toFixed(2)),i.find(".moda span").text(a.moda),i.find(".total span").text(a.totalPx)},events:function(){var a=this;a.elements.contentHead.on("click",".image-upload",function(){a.elements.inputFile.click()}),a.elements.contentHead.on("click",".reset",function(){var t=e.resetImage(!0);a.renderResults(t)}),a.elements.contentHead.on("click",".filter-gray .apply_filter_gray",function(t){var i=e.applyFilter("filterGray");a.renderResults(i),a.loadStatistics()}),a.elements.contentHead.on("click",".negative .apply_filter_negative",function(t){var i=e.applyFilter("negative");a.renderResults(i),a.loadStatistics()});var i=200,n=a.elements.contentHead.find(".binary label.value");function r(t){n.text(t.value),i=t.value}(m=a.elements.contentHead.find("#slider_binary").slider()).on("click",r),m.on("slideStop",r),m.on("slide",function(t){n.text(t.value)}),a.elements.contentHead.on("click",".binary .apply_filter_binary",function(t){var n=e.applyFilter("binary",i);a.renderResults(n),a.loadStatistics()}),a.elements.contentHead.on("click",".detect-border",function(){var t=e.applyFilter("applyFilterMatrix",[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]]);a.renderResults(t)}),a.elements.contentHead.on("click",".transladar",function(){var t=parseInt(prompt("Transladar em top","0"))||0,i=parseInt(prompt("Transladar em left","0"))||0,n=e.applyFilter("transladar",t,i,0,0);a.renderResults(n)}),a.elements.contentHead.on("click",".resize",function(){var t=parseFloat(prompt("Redimencionar em X","0"))||0,i=parseFloat(prompt("Redimencionar em Y","0"))||0,n=e.applyFilter("resize",t,i);a.renderResults(n)});var s=0,o=a.elements.contentHead.find(".rotate label.value");function l(t){o.text(t.value),s=t.value}(m=a.elements.contentHead.find("#slider_rotate").slider()).on("click",l),m.on("slideStop",l),m.on("slide",function(t){o.text(t.value)}),a.elements.contentHead.on("click",".rotate .apply_filter_rotate",function(t){var i=e.applyFilter("rotate",s);a.renderResults(i),a.loadStatistics()});var d=0,h=1,g=a.elements.contentHead.find(".brightness label.value");function c(t){g.text(t.value),d=t.value}(m=a.elements.contentHead.find("#slider_brightness").slider()).on("click",c),m.on("slideStop",c),m.on("slide",function(t){g.text(t.value)}),a.elements.contentHead.on("click",".brightness .apply_filter_brightness",function(t){var i=e.applyFilter("brightnessContrast",d,h);a.renderResults(i),a.loadStatistics()});var m,f=a.elements.contentHead.find(".contrast label.value");function u(t){f.text(t.value),h=t.value}(m=a.elements.contentHead.find("#slider_contrast").slider()).on("click",u),m.on("slideStop",u),m.on("slide",function(t){f.text(t.value)}),a.elements.contentHead.on("click",".contrast .apply_filter_contrast",function(t){var i=e.applyFilter("brightnessContrast",d,h);a.renderResults(i),a.loadStatistics()}),a.elements.contentHead.on("click",".mirror .apply_filter_mirror",function(){var t=a.elements.contentHead.find(".mirror #mirror_x").is(":checked"),i=a.elements.contentHead.find(".mirror #mirror_y").is(":checked"),n=e.applyFilter("mirror",t,i);a.renderResults(n)}),a.elements.inputFile.on("change",function(t){e.loadImagem(event.target.files[0],function(t){a.renderOrigin(t)})}),a.elements.contentHead.on("click",".matrix",function(){var t=e.applyFilter("applyFilterMatrix");a.renderResults(t)}),a.elements.contentHead.on("click",".domino",function(){var t=e.domino();a.renderResults(t)}),a.elements.stack.on("click",".process .remove",function(){var i=t(this).parents("li.process:eq(0)"),n=i.attr("data-index");e.processes.splice(n,1),i.remove();var r=e.processImage();a.renderResults(r)})},renderResults:function(t){for(var e in this.elements.result.html(""),t){var a=t[e],i=a;void 0!=a.dataImg&&(i=a.dataImg);var n=this.elements.modelo.clone();n.removeClass("modelo").addClass("content-image");var r="Resultado (Processo "+(parseInt(e)+1)+")";n.find("h4").html(r);var s=n.find("canvas.canvas-image-change").get(0);s.width=i.width,s.height=i.height,s.getContext("2d").putImageData(i,0,0);var o=n.find(".image-result");o.find(".img-size").text(i.width+"x"+i.height),void 0!=a.type&&o.find(".img-features").append("<span>"+a.type+"</span>"),void 0!=a.color&&o.find(".img-features").append('<div style="width:25px; height:25px; background-color:rgb('+a.color.R+","+a.color.G+","+a.color.B+')"></span>'),this.elements.result.append(n)}this.renderProcessStack()},renderProcessStack:function(){var t=e.processes,a=this.elements.stack.find(".stack-process");for(var i in a.html(""),t){var n=t[i],r=n.name,s=n.params,o=this.elements.stack.find(".model li").clone();o.find(".name").text(r),o.find(".params .value").text(s.join(", ")),o.attr("data-index",i),a.append(o)}},init:function(){return this.elements.inputFile=t("#inputFile"),this.elements.contentHead=t(".content-menu"),this.elements.contentBody=t(".content-render"),this.elements.canvasOri=this.elements.contentBody.find("#canvas-image-origin"),this.elements.canvasChg=this.elements.contentBody.find("#canvas-image-change"),this.elements.modals.config=t("div.modal#configuration"),this.elements.modelo=t(".content-render .modelo"),this.elements.result=t(".content-render .results"),this.elements.stack=t(".content-stack"),this.events(),this}},new a}(jQuery,new PDI);Application.init();